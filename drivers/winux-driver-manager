#!/bin/bash
# =============================================================================
# Winux Driver Manager
# =============================================================================
# Detecta e instala drivers de GPU automaticamente
# =============================================================================

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# -----------------------------------------------------------------------------
# Detecção de GPU
# -----------------------------------------------------------------------------

detect_gpu() {
    local gpu_info
    gpu_info=$(lspci -nn 2>/dev/null | grep -E "VGA|3D|Display" || echo "")

    if echo "$gpu_info" | grep -qi "nvidia"; then
        echo "nvidia"
    elif echo "$gpu_info" | grep -qi "amd\|radeon"; then
        echo "amd"
    elif echo "$gpu_info" | grep -qi "intel"; then
        echo "intel"
    else
        echo "unknown"
    fi
}

get_gpu_model() {
    lspci -nn 2>/dev/null | grep -E "VGA|3D|Display" | head -1 | sed 's/.*: //'
}

# -----------------------------------------------------------------------------
# NVIDIA
# -----------------------------------------------------------------------------

get_nvidia_driver_version() {
    local gpu_pci_id
    gpu_pci_id=$(lspci -nn 2>/dev/null | grep -i nvidia | grep -oP '\[10de:\K[0-9a-f]+' | head -1)

    case "$gpu_pci_id" in
        # RTX 40 series / RTX 30 series
        2684|2702|2704|2705|2782|2783|2786|2204|2206|2208|220a|2216|2484|2486|2488|2489)
            echo "550"
            ;;
        # RTX 20 series / GTX 16 series
        1e04|1e07|1e82|1e84|1e87|1e89|1f02|1f06|1f07|1f08|1f82|1f91)
            echo "535"
            ;;
        # GTX 10 series
        1b80|1b81|1b82|1b83|1b84|1c02|1c03|1c81|1c82)
            echo "535"
            ;;
        # Older cards
        *)
            echo "470"
            ;;
    esac
}

install_nvidia() {
    local driver_version="${1:-$(get_nvidia_driver_version)}"

    log_info "Instalando driver NVIDIA versão ${driver_version}..."

    # Adicionar PPA
    add-apt-repository -y ppa:graphics-drivers/ppa
    apt update

    # Instalar driver
    apt install -y \
        "nvidia-driver-${driver_version}" \
        "nvidia-dkms-${driver_version}" \
        "nvidia-utils-${driver_version}" \
        "libnvidia-gl-${driver_version}:amd64" \
        nvidia-settings \
        vulkan-tools

    # Configurar módulos
    cat > /etc/modprobe.d/nvidia-winux.conf << 'EOF'
# Winux NVIDIA Configuration
options nvidia-drm modeset=1
options nvidia NVreg_UsePageAttributeTable=1
options nvidia NVreg_EnablePCIeGen3=1
options nvidia NVreg_PreserveVideoMemoryAllocations=1
blacklist nouveau
EOF

    # Variáveis de ambiente
    cat > /etc/environment.d/nvidia-winux.conf << 'EOF'
GBM_BACKEND=nvidia-drm
__GLX_VENDOR_LIBRARY_NAME=nvidia
WLR_NO_HARDWARE_CURSORS=1
EOF

    update-initramfs -u

    log_info "Driver NVIDIA ${driver_version} instalado com sucesso!"
}

# -----------------------------------------------------------------------------
# AMD
# -----------------------------------------------------------------------------

install_amd() {
    log_info "Instalando drivers AMD (Mesa/RADV)..."

    apt install -y \
        mesa-vulkan-drivers \
        mesa-vulkan-drivers:i386 \
        libgl1-mesa-dri:amd64 \
        libgl1-mesa-dri:i386 \
        mesa-utils \
        vulkan-tools \
        radeontop

    # Configurações
    cat > /etc/modprobe.d/amdgpu-winux.conf << 'EOF'
# Winux AMD Configuration
options amdgpu ppfeaturemask=0xffffffff
options amdgpu gpu_recovery=1
options amdgpu dc=1
EOF

    cat > /etc/environment.d/amd-winux.conf << 'EOF'
RADV_PERFTEST=gpl
AMD_VULKAN_ICD=RADV
mesa_glthread=true
EOF

    update-initramfs -u

    log_info "Drivers AMD instalados com sucesso!"
}

# -----------------------------------------------------------------------------
# Intel
# -----------------------------------------------------------------------------

install_intel() {
    log_info "Instalando drivers Intel (Mesa/ANV)..."

    apt install -y \
        mesa-vulkan-drivers \
        mesa-vulkan-drivers:i386 \
        intel-media-va-driver \
        vulkan-tools

    cat > /etc/environment.d/intel-winux.conf << 'EOF'
mesa_glthread=true
EOF

    log_info "Drivers Intel instalados com sucesso!"
}

# -----------------------------------------------------------------------------
# Interface
# -----------------------------------------------------------------------------

show_banner() {
    echo ""
    echo "╔════════════════════════════════════════════╗"
    echo "║      Winux Hardware Detection (WHD)        ║"
    echo "╚════════════════════════════════════════════╝"
    echo ""
}

interactive_install() {
    show_banner

    local gpu
    gpu=$(detect_gpu)
    local model
    model=$(get_gpu_model)

    echo "GPU detectada: ${model}"
    echo "Fabricante: ${gpu}"
    echo ""

    case "$gpu" in
        nvidia)
            local driver_version
            driver_version=$(get_nvidia_driver_version)
            echo "Driver recomendado: nvidia-${driver_version}"
            echo ""
            read -p "Instalar driver NVIDIA ${driver_version}? [Y/n] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                install_nvidia "$driver_version"
            fi
            ;;
        amd)
            echo "Usando drivers Mesa/RADV (open source)"
            read -p "Instalar drivers AMD? [Y/n] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                install_amd
            fi
            ;;
        intel)
            echo "Usando drivers Mesa/ANV"
            read -p "Instalar drivers Intel? [Y/n] " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                install_intel
            fi
            ;;
        *)
            log_warn "GPU não reconhecida"
            log_info "Usando drivers genéricos do sistema"
            ;;
    esac

    echo ""
    log_info "Configuração concluída!"
    log_warn "Reinicie o sistema para aplicar as mudanças."
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

main() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Este script deve ser executado como root"
        exit 1
    fi

    case "${1:-}" in
        --detect)
            detect_gpu
            ;;
        --nvidia)
            install_nvidia "${2:-}"
            ;;
        --amd)
            install_amd
            ;;
        --intel)
            install_intel
            ;;
        --help|-h)
            echo "Uso: winux-driver-manager [opção]"
            echo ""
            echo "Opções:"
            echo "  (sem opção)   Modo interativo"
            echo "  --detect      Apenas detectar GPU"
            echo "  --nvidia      Instalar driver NVIDIA"
            echo "  --amd         Instalar drivers AMD"
            echo "  --intel       Instalar drivers Intel"
            echo "  --help        Mostrar esta ajuda"
            ;;
        *)
            interactive_install
            ;;
    esac
}

main "$@"
