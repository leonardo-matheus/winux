#!/bin/bash
# =============================================================================
# Winux Java - Java Version Manager
# =============================================================================
# Ferramenta para gerenciar versões do Java facilmente
# =============================================================================

VERSION="1.0.0"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

log_info() { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[✗]${NC} $1"; }

show_help() {
    echo -e "${CYAN}"
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║  Winux Java - Java Version Manager                          ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${BOLD}Uso:${NC} winux-java <comando>"
    echo ""
    echo -e "${BOLD}Comandos:${NC}"
    echo -e "  ${GREEN}list${NC}              Lista todas as versões instaladas"
    echo -e "  ${GREEN}current${NC}           Mostra a versão atual"
    echo -e "  ${GREEN}use <versão>${NC}      Define a versão do Java (8, 11, 17, 21)"
    echo -e "  ${GREEN}home${NC}              Mostra JAVA_HOME atual"
    echo -e "  ${GREEN}install${NC}           Instala versões faltantes"
    echo ""
    echo -e "${BOLD}Exemplos:${NC}"
    echo "  winux-java list"
    echo "  winux-java use 17"
    echo "  winux-java use 21"
    echo ""
}

list_versions() {
    echo -e "${CYAN}Versões do Java instaladas:${NC}"
    echo ""

    local current=$(java -version 2>&1 | head -1 | awk -F '"' '{print $2}' | cut -d'.' -f1)

    for ver in 8 11 17 21; do
        local jdk_path="/usr/lib/jvm/java-${ver}-openjdk-amd64"
        if [[ -d "$jdk_path" ]]; then
            if [[ "$current" == "$ver" ]] || [[ "$current" == "1" && "$ver" == "8" ]]; then
                echo -e "  ${GREEN}→ Java ${ver}${NC} (atual)"
            else
                echo -e "    Java ${ver}"
            fi
        else
            echo -e "  ${YELLOW}  Java ${ver}${NC} (não instalado)"
        fi
    done
    echo ""
}

show_current() {
    echo -e "${CYAN}Java atual:${NC}"
    java -version 2>&1
    echo ""
    echo -e "${CYAN}JAVA_HOME:${NC} ${JAVA_HOME:-não definido}"
    echo -e "${CYAN}Caminho:${NC} $(which java)"
}

use_version() {
    local version="$1"

    # Normalizar versão
    case "$version" in
        8|1.8) version="8" ;;
        11) version="11" ;;
        17) version="17" ;;
        21) version="21" ;;
        *)
            log_error "Versão inválida: $version"
            echo "Versões disponíveis: 8, 11, 17, 21"
            exit 1
            ;;
    esac

    local jdk_path="/usr/lib/jvm/java-${version}-openjdk-amd64"

    if [[ ! -d "$jdk_path" ]]; then
        log_error "Java $version não está instalado"
        echo "Execute: sudo apt install openjdk-${version}-jdk"
        exit 1
    fi

    log_info "Configurando Java $version como padrão..."

    sudo update-alternatives --set java "${jdk_path}/bin/java" 2>/dev/null
    sudo update-alternatives --set javac "${jdk_path}/bin/javac" 2>/dev/null
    sudo update-alternatives --set jar "${jdk_path}/bin/jar" 2>/dev/null

    # Atualizar JAVA_HOME no .bashrc se existir
    if grep -q "^export JAVA_HOME=" ~/.bashrc 2>/dev/null; then
        sed -i "s|^export JAVA_HOME=.*|export JAVA_HOME=${jdk_path}|" ~/.bashrc
    else
        echo "export JAVA_HOME=${jdk_path}" >> ~/.bashrc
    fi

    export JAVA_HOME="$jdk_path"

    log_info "Java $version configurado!"
    echo ""
    java -version 2>&1
    echo ""
    log_warn "Execute 'source ~/.bashrc' ou abra um novo terminal para atualizar JAVA_HOME"
}

show_home() {
    if [[ -n "$JAVA_HOME" ]]; then
        echo "$JAVA_HOME"
    else
        local java_bin=$(which java 2>/dev/null)
        if [[ -n "$java_bin" ]]; then
            local real_path=$(readlink -f "$java_bin")
            echo "${real_path%/bin/java}"
        else
            log_error "Java não encontrado"
            exit 1
        fi
    fi
}

install_all() {
    log_info "Instalando todas as versões do Java..."
    sudo apt update
    sudo apt install -y openjdk-8-jdk openjdk-11-jdk openjdk-17-jdk openjdk-21-jdk maven gradle ant
    log_info "Todas as versões instaladas!"
    list_versions
}

# Main
case "$1" in
    list|ls)
        list_versions
        ;;
    current|version)
        show_current
        ;;
    use|switch)
        if [[ -z "$2" ]]; then
            log_error "Especifique a versão: winux-java use <8|11|17|21>"
            exit 1
        fi
        use_version "$2"
        ;;
    home)
        show_home
        ;;
    install)
        install_all
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        log_error "Comando desconhecido: $1"
        echo "Use 'winux-java help' para ver os comandos"
        exit 1
        ;;
esac
