#!/bin/bash
# =============================================================================
# Winux Dev - Developer Stack Manager
# =============================================================================
# Ferramenta para instalar e gerenciar stacks de desenvolvimento
# =============================================================================

VERSION="1.0.0"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
╔══════════════════════════════════════════════════════════════╗
║  ██╗    ██╗██╗███╗   ██╗██╗   ██╗██╗  ██╗                   ║
║  ██║    ██║██║████╗  ██║██║   ██║╚██╗██╔╝                   ║
║  ██║ █╗ ██║██║██╔██╗ ██║██║   ██║ ╚███╔╝                    ║
║  ██║███╗██║██║██║╚██╗██║██║   ██║ ██╔██╗                    ║
║  ╚███╔███╔╝██║██║ ╚████║╚██████╔╝██╔╝ ██╗   DEV            ║
║   ╚══╝╚══╝ ╚═╝╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═╝                   ║
║                                                              ║
║  Developer Stack Manager v1.0                               ║
╚══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

show_help() {
    show_banner
    echo -e "${BOLD}Uso:${NC} winux-dev <comando> [opções]"
    echo ""
    echo -e "${BOLD}Comandos:${NC}"
    echo -e "  ${GREEN}install${NC} <stack>    Instala uma stack de desenvolvimento"
    echo -e "  ${GREEN}list${NC}               Lista todas as stacks disponíveis"
    echo -e "  ${GREEN}status${NC}             Mostra status das ferramentas instaladas"
    echo -e "  ${GREEN}services${NC}           Gerencia serviços (start/stop/status)"
    echo -e "  ${GREEN}update${NC}             Atualiza todas as ferramentas"
    echo -e "  ${GREEN}doctor${NC}             Verifica problemas no ambiente"
    echo ""
    echo -e "${BOLD}Stacks disponíveis:${NC}"
    echo -e "  ${CYAN}web${NC}        Node.js, npm, yarn, pnpm"
    echo -e "  ${CYAN}python${NC}     Python, pip, venv, poetry"
    echo -e "  ${CYAN}rust${NC}       Rust, Cargo, rustfmt, clippy"
    echo -e "  ${CYAN}go${NC}         Go, gopls"
    echo -e "  ${CYAN}java${NC}       OpenJDK, Maven, Gradle"
    echo -e "  ${CYAN}php${NC}        PHP, Composer, Laravel CLI"
    echo -e "  ${CYAN}devops${NC}     Docker, kubectl, helm, terraform"
    echo -e "  ${CYAN}database${NC}   PostgreSQL, MySQL, Redis, MongoDB"
    echo -e "  ${CYAN}mobile${NC}     Flutter, Android SDK"
    echo -e "  ${CYAN}all${NC}        Todas as stacks"
    echo ""
    echo -e "${BOLD}Exemplos:${NC}"
    echo "  winux-dev install web"
    echo "  winux-dev install rust go"
    echo "  winux-dev services start postgres"
    echo "  winux-dev status"
    echo ""
}

log_info() { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[✗]${NC} $1"; }
log_step() { echo -e "${BLUE}[→]${NC} ${BOLD}$1${NC}"; }

install_web() {
    log_step "Instalando stack Web (Node.js)..."

    # NVM
    if [[ ! -d "$HOME/.nvm" ]]; then
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    fi

    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

    nvm install --lts
    nvm alias default node

    npm install -g yarn pnpm typescript ts-node nodemon pm2 eslint prettier vite

    log_info "Stack Web instalada: Node $(node --version)"
}

install_python() {
    log_step "Instalando stack Python..."

    sudo apt install -y python3 python3-pip python3-venv python3-dev pipx

    pipx install poetry
    pipx install black
    pipx install flake8
    pipx install mypy
    pipx install ipython
    pipx install httpie

    log_info "Stack Python instalada: $(python3 --version)"
}

install_rust() {
    log_step "Instalando stack Rust..."

    if ! command -v rustc &> /dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
    fi

    rustup component add rustfmt clippy rust-analyzer
    rustup target add wasm32-unknown-unknown

    cargo install cargo-watch cargo-edit cargo-audit sccache

    log_info "Stack Rust instalada: $(rustc --version)"
}

install_go() {
    log_step "Instalando stack Go..."

    GO_VERSION="1.22.0"
    wget -q "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -O /tmp/go.tar.gz
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf /tmp/go.tar.gz
    rm /tmp/go.tar.gz

    export PATH=$PATH:/usr/local/go/bin

    go install golang.org/x/tools/gopls@latest
    go install github.com/go-delve/delve/cmd/dlv@latest

    log_info "Stack Go instalada: $(go version)"
}

install_java() {
    log_step "Instalando stack Java completa..."

    # Múltiplas versões do JDK
    sudo apt install -y \
        openjdk-8-jdk \
        openjdk-11-jdk \
        openjdk-17-jdk \
        openjdk-21-jdk \
        maven \
        gradle \
        ant \
        visualvm

    # SDKMAN para gerenciar versões Java
    if [[ ! -d "$HOME/.sdkman" ]]; then
        curl -s "https://get.sdkman.io" | bash
        source "$HOME/.sdkman/bin/sdkman-init.sh"
    fi

    # Spring Boot CLI
    if command -v sdk &>/dev/null; then
        sdk install springboot || true
    fi

    # JBang (runner de scripts Java)
    curl -Ls https://sh.jbang.dev | bash -s - app setup 2>/dev/null || true

    # Configurar JAVA_HOME
    echo 'export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64' >> ~/.bashrc
    echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc

    log_info "Stack Java instalada com JDK 8, 11, 17 e 21"
    log_info "Use 'sudo update-alternatives --config java' para trocar versão"
    log_info "Ou use SDKMAN: sdk use java <version>"
}

install_php() {
    log_step "Instalando stack PHP..."

    sudo apt install -y php php-cli php-fpm php-mysql php-pgsql php-curl php-gd php-mbstring php-xml php-zip php-bcmath php-redis

    # Composer
    if ! command -v composer &> /dev/null; then
        curl -sS https://getcomposer.org/installer | php
        sudo mv composer.phar /usr/local/bin/composer
    fi

    # Laravel CLI
    composer global require laravel/installer

    log_info "Stack PHP instalada: $(php --version | head -1)"
}

install_devops() {
    log_step "Instalando stack DevOps..."

    # Docker
    if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | sudo sh
        sudo usermod -aG docker $USER
    fi

    # kubectl
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    rm kubectl

    # Helm
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    # Terraform
    sudo snap install terraform --classic

    log_info "Stack DevOps instalada"
}

install_database() {
    log_step "Instalando stack Database..."

    sudo apt install -y postgresql postgresql-contrib mysql-server redis-server sqlite3

    # MongoDB
    wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add - 2>/dev/null
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
    sudo apt update && sudo apt install -y mongodb-org || true

    # Desabilitar por padrão
    sudo systemctl disable postgresql mysql redis-server mongod 2>/dev/null

    log_info "Stack Database instalada"
}

install_mobile() {
    log_step "Instalando stack Mobile (Flutter)..."

    # Flutter
    sudo snap install flutter --classic
    flutter doctor --android-licenses 2>/dev/null || true

    log_info "Stack Mobile instalada"
}

show_status() {
    show_banner
    echo -e "${BOLD}Status das Ferramentas:${NC}"
    echo ""

    # Linguagens
    echo -e "${CYAN}Linguagens:${NC}"
    command -v rustc &>/dev/null && echo -e "  ${GREEN}✓${NC} Rust: $(rustc --version 2>/dev/null)" || echo -e "  ${RED}✗${NC} Rust: não instalado"
    command -v node &>/dev/null && echo -e "  ${GREEN}✓${NC} Node.js: $(node --version 2>/dev/null)" || echo -e "  ${RED}✗${NC} Node.js: não instalado"
    command -v python3 &>/dev/null && echo -e "  ${GREEN}✓${NC} Python: $(python3 --version 2>/dev/null)" || echo -e "  ${RED}✗${NC} Python: não instalado"
    command -v go &>/dev/null && echo -e "  ${GREEN}✓${NC} Go: $(go version 2>/dev/null | awk '{print $3}')" || echo -e "  ${RED}✗${NC} Go: não instalado"
    command -v java &>/dev/null && echo -e "  ${GREEN}✓${NC} Java: $(java --version 2>/dev/null | head -1)" || echo -e "  ${RED}✗${NC} Java: não instalado"
    command -v php &>/dev/null && echo -e "  ${GREEN}✓${NC} PHP: $(php --version 2>/dev/null | head -1 | awk '{print $2}')" || echo -e "  ${RED}✗${NC} PHP: não instalado"

    echo ""
    echo -e "${CYAN}Ferramentas:${NC}"
    command -v docker &>/dev/null && echo -e "  ${GREEN}✓${NC} Docker: $(docker --version 2>/dev/null | awk '{print $3}')" || echo -e "  ${RED}✗${NC} Docker: não instalado"
    command -v code &>/dev/null && echo -e "  ${GREEN}✓${NC} VS Code: instalado" || echo -e "  ${RED}✗${NC} VS Code: não instalado"
    command -v git &>/dev/null && echo -e "  ${GREEN}✓${NC} Git: $(git --version 2>/dev/null | awk '{print $3}')" || echo -e "  ${RED}✗${NC} Git: não instalado"

    echo ""
    echo -e "${CYAN}Serviços:${NC}"
    systemctl is-active --quiet postgresql && echo -e "  ${GREEN}●${NC} PostgreSQL: running" || echo -e "  ${YELLOW}○${NC} PostgreSQL: stopped"
    systemctl is-active --quiet mysql && echo -e "  ${GREEN}●${NC} MySQL: running" || echo -e "  ${YELLOW}○${NC} MySQL: stopped"
    systemctl is-active --quiet redis-server && echo -e "  ${GREEN}●${NC} Redis: running" || echo -e "  ${YELLOW}○${NC} Redis: stopped"
    systemctl is-active --quiet docker && echo -e "  ${GREEN}●${NC} Docker: running" || echo -e "  ${YELLOW}○${NC} Docker: stopped"

    echo ""
}

manage_services() {
    local action="$1"
    local service="$2"

    case "$service" in
        postgres|postgresql) service="postgresql" ;;
        mysql|mariadb) service="mysql" ;;
        redis) service="redis-server" ;;
        mongo|mongodb) service="mongod" ;;
    esac

    case "$action" in
        start)
            sudo systemctl start "$service"
            log_info "$service iniciado"
            ;;
        stop)
            sudo systemctl stop "$service"
            log_info "$service parado"
            ;;
        restart)
            sudo systemctl restart "$service"
            log_info "$service reiniciado"
            ;;
        status)
            systemctl status "$service"
            ;;
        *)
            log_error "Ação desconhecida: $action"
            echo "Use: start, stop, restart, status"
            ;;
    esac
}

run_doctor() {
    show_banner
    echo -e "${BOLD}Verificando ambiente de desenvolvimento...${NC}"
    echo ""

    local issues=0

    # Verificar Git
    if ! command -v git &>/dev/null; then
        log_error "Git não encontrado"
        ((issues++))
    else
        log_info "Git OK"
    fi

    # Verificar build-essential
    if ! dpkg -l build-essential &>/dev/null; then
        log_error "build-essential não instalado"
        ((issues++))
    else
        log_info "Build tools OK"
    fi

    # Verificar espaço em disco
    local free_space=$(df -BG / | awk 'NR==2 {print $4}' | tr -d 'G')
    if [[ $free_space -lt 10 ]]; then
        log_warn "Espaço em disco baixo: ${free_space}GB"
        ((issues++))
    else
        log_info "Espaço em disco OK: ${free_space}GB livres"
    fi

    # Verificar memória
    local total_mem=$(free -g | awk '/^Mem:/ {print $2}')
    if [[ $total_mem -lt 4 ]]; then
        log_warn "Pouca memória RAM: ${total_mem}GB"
        ((issues++))
    else
        log_info "Memória OK: ${total_mem}GB"
    fi

    echo ""
    if [[ $issues -eq 0 ]]; then
        echo -e "${GREEN}Nenhum problema encontrado!${NC}"
    else
        echo -e "${YELLOW}$issues problema(s) encontrado(s)${NC}"
    fi
}

# Main
case "$1" in
    install)
        shift
        if [[ $# -eq 0 ]]; then
            log_error "Especifique uma stack para instalar"
            echo "Use: winux-dev install <stack>"
            exit 1
        fi

        for stack in "$@"; do
            case "$stack" in
                web|node|nodejs) install_web ;;
                python|py) install_python ;;
                rust|rs) install_rust ;;
                go|golang) install_go ;;
                java|jdk) install_java ;;
                php) install_php ;;
                devops) install_devops ;;
                database|db) install_database ;;
                mobile|flutter) install_mobile ;;
                all)
                    install_web
                    install_python
                    install_rust
                    install_go
                    install_java
                    install_php
                    install_devops
                    install_database
                    ;;
                *)
                    log_error "Stack desconhecida: $stack"
                    ;;
            esac
        done
        ;;

    list)
        show_banner
        echo -e "${BOLD}Stacks disponíveis:${NC}"
        echo ""
        echo -e "  ${CYAN}web${NC}        Node.js, npm, yarn, pnpm, TypeScript"
        echo -e "  ${CYAN}python${NC}     Python, pip, venv, poetry, black"
        echo -e "  ${CYAN}rust${NC}       Rust, Cargo, rustfmt, clippy, rust-analyzer"
        echo -e "  ${CYAN}go${NC}         Go, gopls, delve"
        echo -e "  ${CYAN}java${NC}       OpenJDK 21, Maven, Gradle"
        echo -e "  ${CYAN}php${NC}        PHP, Composer, Laravel CLI"
        echo -e "  ${CYAN}devops${NC}     Docker, kubectl, helm, terraform"
        echo -e "  ${CYAN}database${NC}   PostgreSQL, MySQL, Redis, MongoDB, SQLite"
        echo -e "  ${CYAN}mobile${NC}     Flutter, Android SDK"
        echo ""
        ;;

    status)
        show_status
        ;;

    services)
        shift
        if [[ $# -lt 2 ]]; then
            log_error "Uso: winux-dev services <start|stop|restart|status> <serviço>"
            exit 1
        fi
        manage_services "$1" "$2"
        ;;

    doctor)
        run_doctor
        ;;

    update)
        log_step "Atualizando ferramentas..."
        sudo apt update && sudo apt upgrade -y
        rustup update 2>/dev/null || true
        npm update -g 2>/dev/null || true
        pipx upgrade-all 2>/dev/null || true
        log_info "Atualização concluída"
        ;;

    version|--version|-v)
        echo "winux-dev version $VERSION"
        ;;

    help|--help|-h|"")
        show_help
        ;;

    *)
        log_error "Comando desconhecido: $1"
        echo "Use 'winux-dev help' para ver os comandos disponíveis"
        exit 1
        ;;
esac
