# =============================================================================
# Winux OS - Kernel Performance Tunables
# /etc/sysctl.d/99-winux-performance.conf
# =============================================================================
# Optimized for gaming, desktop responsiveness, and low-latency workloads
# Based on Winux OS Specification v1.0
# =============================================================================

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Swappiness: Lower value = prefer keeping data in RAM
# 10 is ideal for systems with sufficient RAM (gaming/desktop)
vm.swappiness = 10

# VFS cache pressure: Lower = keep directory/inode caches longer
vm.vfs_cache_pressure = 50

# Dirty ratio: Percentage of RAM that can be dirty before forced writeback
vm.dirty_ratio = 15

# Background dirty ratio: Start background writeback at this percentage
vm.dirty_background_ratio = 5

# Dirty writeback interval (centisecs) - more frequent = smoother I/O
vm.dirty_writeback_centisecs = 1500

# Dirty expire (centisecs) - max age of dirty data before writeback
vm.dirty_expire_centisecs = 3000

# Overcommit memory: 1 = always overcommit (better for gaming/desktop)
vm.overcommit_memory = 1

# Max map count: Increase for games and applications with many mappings
vm.max_map_count = 2147483642

# Zone reclaim mode: 0 = disable for better NUMA performance
vm.zone_reclaim_mode = 0

# Compaction proactiveness: Reduce memory fragmentation
vm.compaction_proactiveness = 20

# Page lock unfairness: Reduce for better latency
vm.page_lock_unfairness = 1

# =============================================================================
# TRANSPARENT HUGE PAGES
# =============================================================================

# Enable huge pages for better memory performance
# Note: THP settings are typically in /sys, managed via udev/tmpfiles
# vm.nr_hugepages = 0 (dynamic allocation preferred)

# =============================================================================
# KERNEL SCHEDULER
# =============================================================================

# Minimum granularity for CPU-bound tasks (nanoseconds)
kernel.sched_min_granularity_ns = 500000

# Wakeup granularity (nanoseconds) - lower = more responsive
kernel.sched_wakeup_granularity_ns = 500000

# Latency target for scheduler (nanoseconds)
kernel.sched_latency_ns = 3000000

# Migration cost (nanoseconds)
kernel.sched_migration_cost_ns = 250000

# Child runs first after fork - better for interactive workloads
kernel.sched_child_runs_first = 0

# Autogroup: Enable for better desktop responsiveness
kernel.sched_autogroup_enabled = 1

# =============================================================================
# NETWORK - TCP/IP STACK
# =============================================================================

# TCP Congestion Control: BBR3 for optimal throughput and latency
net.ipv4.tcp_congestion_control = bbr

# Enable BBR's pacing
net.core.default_qdisc = fq

# TCP Fast Open: Enable for both client and server
net.ipv4.tcp_fastopen = 3

# TCP MTU Probing: Auto-discover optimal MTU
net.ipv4.tcp_mtu_probing = 1

# Receive buffer sizes (min, default, max)
net.core.rmem_default = 1048576
net.core.rmem_max = 16777216
net.ipv4.tcp_rmem = 4096 1048576 16777216

# Send buffer sizes (min, default, max)
net.core.wmem_default = 1048576
net.core.wmem_max = 16777216
net.ipv4.tcp_wmem = 4096 1048576 16777216

# Network backlog
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 8192

# TCP keepalive (seconds)
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6

# TCP timeouts
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2

# Enable TCP window scaling
net.ipv4.tcp_window_scaling = 1

# Enable TCP timestamps (for better RTT estimation)
net.ipv4.tcp_timestamps = 1

# Enable SACK (Selective Acknowledgment)
net.ipv4.tcp_sack = 1

# Disable slow start after idle
net.ipv4.tcp_slow_start_after_idle = 0

# Enable low latency mode
net.ipv4.tcp_low_latency = 1

# Increase ephemeral port range
net.ipv4.ip_local_port_range = 1024 65535

# TCP memory (pages)
net.ipv4.tcp_mem = 65536 131072 262144

# =============================================================================
# NETWORK - UDP
# =============================================================================

# UDP buffer sizes
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# =============================================================================
# NETWORK - GENERAL
# =============================================================================

# Enable IP forwarding (for VMs, containers, etc.)
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Disable IPv6 if not needed (uncomment to disable)
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1

# Reverse path filtering (loose mode for gaming/VPN)
net.ipv4.conf.default.rp_filter = 2
net.ipv4.conf.all.rp_filter = 2

# =============================================================================
# KERNEL - SECURITY & MISC
# =============================================================================

# SysRq: Enable some magic keys (useful for debugging)
kernel.sysrq = 176

# Core dumps: Disable for security
kernel.core_pattern = |/bin/false

# Restrict dmesg access (optional - uncomment for security)
# kernel.dmesg_restrict = 1

# Restrict kernel pointer exposure
kernel.kptr_restrict = 1

# Unprivileged BPF disabled by default
kernel.unprivileged_bpf_disabled = 1

# PID max
kernel.pid_max = 4194304

# Threads max
kernel.threads-max = 4194304

# Inotify limits (for file watchers, IDEs, etc.)
fs.inotify.max_user_watches = 1048576
fs.inotify.max_user_instances = 8192
fs.inotify.max_queued_events = 16384

# File handles
fs.file-max = 2097152
fs.nr_open = 2097152

# AIO limits
fs.aio-max-nr = 1048576

# Message queue limits
kernel.msgmax = 65536
kernel.msgmnb = 65536

# =============================================================================
# KERNEL - REAL-TIME & LOW LATENCY
# =============================================================================

# Real-time bandwidth reservation (microseconds per second)
# 950000 = reserve 95% for RT tasks (useful for audio/gaming)
kernel.sched_rt_runtime_us = 980000

# Watchdog timeout
kernel.watchdog_thresh = 10

# NMI watchdog: Disable to save power/reduce interrupts
kernel.nmi_watchdog = 0

# =============================================================================
# End of Winux OS Performance Tunables
# =============================================================================
